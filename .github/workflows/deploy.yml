name: Deploy to AWS Amplify

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Amplify CLI
        run: npm install -g @aws-amplify/cli

      - name: Amplify Pull (headless for Next.js)
        run: |
          amplify pull \
            --appId ${{ secrets.AMPLIFY_APP_ID }} \
            --envName dev \
            --yes \
            --amplify "{\
              \"envName\":\"dev\"\
            }" \
            --frontend "{\
              \"frontend\":\"javascript\",\
              \"framework\":\"nextjs\",\
              \"config\":{\
                \"SourceDir\":\"src\",\
                \"DistributionDir\":\".next\",\
                \"BuildCommand\":\"npm run build\",\
                \"StartCommand\":\"npm run start\"\
              }\
            }" \
            --providers "{\
              \"awscloudformation\":{\
                \"configLevel\":\"project\",\
                \"useProfile\":false,\
                \"accessKeyId\":\"${{ secrets.AWS_ACCESS_KEY_ID }}\",\
                \"secretAccessKey\":\"${{ secrets.AWS_SECRET_ACCESS_KEY }}\",\
                \"region\":\"${{ secrets.AWS_REGION }}\"\
              }\
            }"

      - name: Build and publish frontend to Amplify
        run: |
          npm ci
          npm run build
          amplify publish --yes
